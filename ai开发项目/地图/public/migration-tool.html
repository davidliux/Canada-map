<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¿ç§»å·¥å…· - Vercel KV</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #4ecdc4;
        }
        .button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .button.success {
            background: linear-gradient(45deg, #56ab2f 0%, #a8e6cf 100%);
        }
        .button.danger {
            background: linear-gradient(45deg, #ff416c 0%, #ff4b2b 100%);
        }
        .button.warning {
            background: linear-gradient(45deg, #f7971e 0%, #ffd200 100%);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }
        .status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #2196f3;
        }
        .status.warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffc107;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.3s ease;
        }
        .migration-details {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4ecdc4;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ æ•°æ®è¿ç§»å·¥å…·</h1>
            <p>å°†localStorageæ•°æ®è¿ç§»åˆ°Vercel KVå­˜å‚¨</p>
        </div>

        <!-- è¿ç§»çŠ¶æ€æ£€æŸ¥ -->
        <div class="section">
            <h2>ğŸ“Š è¿ç§»çŠ¶æ€æ£€æŸ¥</h2>
            <button class="button" onclick="checkMigrationStatus()">æ£€æŸ¥è¿ç§»éœ€æ±‚</button>
            <div id="migrationCheck"></div>
            <div class="stats-grid" id="migrationStats"></div>
        </div>

        <!-- è¿ç§»æ“ä½œ -->
        <div class="section">
            <h2>ğŸ”„ æ•°æ®è¿ç§»æ“ä½œ</h2>
            <div class="grid">
                <div>
                    <h3>è‡ªåŠ¨è¿ç§»</h3>
                    <button class="button success" onclick="performAutoMigration()" id="autoMigrateBtn">
                        å¼€å§‹è‡ªåŠ¨è¿ç§»
                    </button>
                    <p style="font-size: 0.9em; opacity: 0.8;">
                        è‡ªåŠ¨æ£€æµ‹å¹¶è¿ç§»localStorageæ•°æ®åˆ°Vercel KV
                    </p>
                </div>
                <div>
                    <h3>æ‰‹åŠ¨è¿ç§»</h3>
                    <button class="button warning" onclick="performManualMigration()" id="manualMigrateBtn">
                        æ‰‹åŠ¨è¿ç§»è®¾ç½®
                    </button>
                    <p style="font-size: 0.9em; opacity: 0.8;">
                        è‡ªå®šä¹‰è¿ç§»é€‰é¡¹å’Œå‚æ•°
                    </p>
                </div>
            </div>
            
            <div id="migrationProgress" style="display: none;">
                <h3>è¿ç§»è¿›åº¦</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">å‡†å¤‡ä¸­...</div>
            </div>
        </div>

        <!-- è¿ç§»ç»“æœ */
        <div class="section">
            <h2>ğŸ“‹ è¿ç§»ç»“æœ</h2>
            <div id="migrationResult"></div>
            <div class="migration-details" id="migrationDetails" style="display: none;"></div>
        </div>

        <!-- éªŒè¯å’Œæµ‹è¯• -->
        <div class="section">
            <h2>âœ… éªŒè¯å’Œæµ‹è¯•</h2>
            <div class="grid">
                <button class="button" onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
                <button class="button" onclick="verifyMigration()">éªŒè¯è¿ç§»ç»“æœ</button>
                <button class="button" onclick="compareData()">å¯¹æ¯”æ•°æ®</button>
                <button class="button success" onclick="openMainApp()">æ‰“å¼€ä¸»åº”ç”¨</button>
            </div>
            <div id="testResults"></div>
        </div>

        <!-- ç´§æ€¥æ“ä½œ -->
        <div class="section">
            <h2>ğŸ†˜ ç´§æ€¥æ“ä½œ</h2>
            <div class="grid">
                <button class="button danger" onclick="rollbackMigration()">å›æ»šè¿ç§»</button>
                <button class="button warning" onclick="createEmergencyBackup()">åˆ›å»ºç´§æ€¥å¤‡ä»½</button>
                <button class="button" onclick="clearAPIData()">æ¸…é™¤APIæ•°æ®</button>
                <button class="button" onclick="resetMigrationStatus()">é‡ç½®è¿ç§»çŠ¶æ€</button>
            </div>
            <div id="emergencyResults"></div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿè¿ç§»ç®¡ç†å™¨ï¼ˆå®é™…åº”ç”¨ä¸­ä¼šä»æ¨¡å—å¯¼å…¥ï¼‰
        class MigrationManager {
            constructor() {
                this.status = {
                    inProgress: false,
                    completed: false,
                    error: null,
                    migratedRegions: 0,
                    totalRegions: 0,
                    details: []
                };
            }

            async checkMigrationNeeded() {
                // æ£€æŸ¥localStorageæ•°æ®
                const localData = JSON.parse(localStorage.getItem('regionConfigs') || '{}');
                const localCount = Object.keys(localData).length;

                // æ¨¡æ‹ŸAPIæ£€æŸ¥
                let apiCount = 0;
                try {
                    const response = await fetch('/api/regions?includeStats=true');
                    if (response.ok) {
                        const data = await response.json();
                        apiCount = data.data.stats?.totalRegions || 0;
                    }
                } catch (error) {
                    console.log('APIæ£€æŸ¥å¤±è´¥:', error);
                }

                return {
                    needed: localCount > 0 && apiCount < localCount,
                    localCount,
                    apiCount,
                    reason: localCount > apiCount ? `éœ€è¦è¿ç§» ${localCount - apiCount} ä¸ªåŒºåŸŸ` : 'æ— éœ€è¿ç§»'
                };
            }

            async performMigration(options = {}) {
                this.status.inProgress = true;
                this.status.error = null;
                this.status.migratedRegions = 0;
                this.status.details = [];

                try {
                    const localData = JSON.parse(localStorage.getItem('regionConfigs') || '{}');
                    const regionIds = Object.keys(localData);
                    this.status.totalRegions = regionIds.length;

                    if (regionIds.length === 0) {
                        throw new Error('æ²¡æœ‰æ‰¾åˆ°éœ€è¦è¿ç§»çš„æ•°æ®');
                    }

                    // æ‰¹é‡è¿ç§»
                    for (let i = 0; i < regionIds.length; i++) {
                        const regionId = regionIds[i];
                        const config = localData[regionId];

                        try {
                            const response = await fetch(`/api/regions/${regionId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(config)
                            });

                            if (response.ok) {
                                this.status.migratedRegions++;
                                this.status.details.push({
                                    type: 'success',
                                    message: `åŒºåŸŸ ${regionId} è¿ç§»æˆåŠŸ`,
                                    timestamp: new Date().toISOString()
                                });
                            } else {
                                throw new Error(`HTTP ${response.status}`);
                            }
                        } catch (error) {
                            this.status.details.push({
                                type: 'error',
                                message: `åŒºåŸŸ ${regionId} è¿ç§»å¤±è´¥: ${error.message}`,
                                timestamp: new Date().toISOString()
                            });
                        }

                        // æ›´æ–°è¿›åº¦
                        const progress = ((i + 1) / regionIds.length) * 100;
                        this.updateProgress(progress, `è¿ç§»åŒºåŸŸ ${regionId} (${i + 1}/${regionIds.length})`);

                        // æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }

                    this.status.completed = true;
                    this.status.inProgress = false;

                    return {
                        success: true,
                        migratedRegions: this.status.migratedRegions,
                        totalRegions: this.status.totalRegions,
                        details: this.status.details
                    };

                } catch (error) {
                    this.status.error = error.message;
                    this.status.inProgress = false;
                    throw error;
                }
            }

            updateProgress(percentage, text) {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                if (progressFill) progressFill.style.width = `${percentage}%`;
                if (progressText) progressText.textContent = text;
            }
        }

        const migrationManager = new MigrationManager();

        // å…¨å±€å‡½æ•°
        window.checkMigrationStatus = async function() {
            try {
                const result = await migrationManager.checkMigrationNeeded();
                
                document.getElementById('migrationCheck').innerHTML = `
                    <div class="status ${result.needed ? 'warning' : 'success'}">
                        ${result.needed ? 'âš ï¸ éœ€è¦è¿ç§»' : 'âœ… æ— éœ€è¿ç§»'}: ${result.reason}
                    </div>
                `;

                document.getElementById('migrationStats').innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number">${result.localCount}</div>
                        <div class="stat-label">localStorageåŒºåŸŸ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.apiCount}</div>
                        <div class="stat-label">APIåŒºåŸŸ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${Math.max(0, result.localCount - result.apiCount)}</div>
                        <div class="stat-label">éœ€è¦è¿ç§»</div>
                    </div>
                `;

                // å¯ç”¨/ç¦ç”¨è¿ç§»æŒ‰é’®
                const autoBtn = document.getElementById('autoMigrateBtn');
                const manualBtn = document.getElementById('manualMigrateBtn');
                
                if (result.needed) {
                    autoBtn.disabled = false;
                    manualBtn.disabled = false;
                } else {
                    autoBtn.disabled = true;
                    manualBtn.disabled = true;
                }

            } catch (error) {
                document.getElementById('migrationCheck').innerHTML = `
                    <div class="status error">
                        âŒ æ£€æŸ¥å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        };

        window.performAutoMigration = async function() {
            const progressDiv = document.getElementById('migrationProgress');
            const resultDiv = document.getElementById('migrationResult');
            const detailsDiv = document.getElementById('migrationDetails');

            progressDiv.style.display = 'block';
            resultDiv.innerHTML = '';
            detailsDiv.style.display = 'none';

            try {
                const result = await migrationManager.performMigration();
                
                resultDiv.innerHTML = `
                    <div class="status success">
                        âœ… è¿ç§»å®Œæˆï¼æˆåŠŸè¿ç§» ${result.migratedRegions}/${result.totalRegions} ä¸ªåŒºåŸŸ
                    </div>
                `;

                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = result.details.map(detail => 
                    `[${detail.timestamp.split('T')[1].split('.')[0]}] ${detail.type.toUpperCase()}: ${detail.message}`
                ).join('\n');

                progressDiv.style.display = 'none';

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        âŒ è¿ç§»å¤±è´¥: ${error.message}
                    </div>
                `;
                progressDiv.style.display = 'none';
            }
        };

        window.performManualMigration = function() {
            alert('æ‰‹åŠ¨è¿ç§»åŠŸèƒ½å¼€å‘ä¸­...\n\nå¯é…ç½®é€‰é¡¹ï¼š\n- æ‰¹é‡å¤§å°\n- è¦†ç›–ç°æœ‰æ•°æ®\n- åˆ›å»ºå¤‡ä»½\n- è¿ç§»ç‰¹å®šåŒºåŸŸ');
        };

        window.testAPIConnection = async function() {
            try {
                const response = await fetch('/api/regions');
                const result = response.ok ? 'âœ… APIè¿æ¥æ­£å¸¸' : `âŒ APIè¿æ¥å¤±è´¥: ${response.status}`;
                
                document.getElementById('testResults').innerHTML = `
                    <div class="status ${response.ok ? 'success' : 'error'}">
                        ${result}
                    </div>
                `;
            } catch (error) {
                document.getElementById('testResults').innerHTML = `
                    <div class="status error">
                        âŒ APIè¿æ¥å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        };

        window.verifyMigration = async function() {
            try {
                const localData = JSON.parse(localStorage.getItem('regionConfigs') || '{}');
                const response = await fetch('/api/regions');
                const apiResult = await response.json();
                const apiData = apiResult.data || {};

                const localCount = Object.keys(localData).length;
                const apiCount = Object.keys(apiData).length;
                const isValid = localCount === apiCount;

                document.getElementById('testResults').innerHTML = `
                    <div class="status ${isValid ? 'success' : 'warning'}">
                        ${isValid ? 'âœ… éªŒè¯é€šè¿‡' : 'âš ï¸ æ•°æ®ä¸åŒ¹é…'}: localStorage(${localCount}) vs API(${apiCount})
                    </div>
                `;
            } catch (error) {
                document.getElementById('testResults').innerHTML = `
                    <div class="status error">
                        âŒ éªŒè¯å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        };

        window.compareData = function() {
            alert('æ•°æ®å¯¹æ¯”åŠŸèƒ½å¼€å‘ä¸­...\n\nå°†æ˜¾ç¤ºï¼š\n- ç¼ºå¤±çš„åŒºåŸŸ\n- å¤šä½™çš„åŒºåŸŸ\n- æ•°æ®å·®å¼‚è¯¦æƒ…');
        };

        window.openMainApp = function() {
            window.open('/', '_blank');
        };

        window.rollbackMigration = function() {
            if (confirm('ç¡®å®šè¦å›æ»šè¿ç§»å—ï¼Ÿè¿™å°†æ¸…é™¤APIä¸­çš„æ•°æ®ã€‚')) {
                alert('å›æ»šåŠŸèƒ½å¼€å‘ä¸­...');
            }
        };

        window.createEmergencyBackup = function() {
            try {
                const localData = JSON.parse(localStorage.getItem('regionConfigs') || '{}');
                const backupData = {
                    regionConfigs: localData,
                    timestamp: new Date().toISOString(),
                    type: 'emergency_backup'
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `emergency-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                document.getElementById('emergencyResults').innerHTML = `
                    <div class="status success">
                        âœ… ç´§æ€¥å¤‡ä»½å·²ä¸‹è½½
                    </div>
                `;
            } catch (error) {
                document.getElementById('emergencyResults').innerHTML = `
                    <div class="status error">
                        âŒ å¤‡ä»½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        };

        window.clearAPIData = function() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤APIä¸­çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                alert('æ¸…é™¤APIæ•°æ®åŠŸèƒ½å¼€å‘ä¸­...');
            }
        };

        window.resetMigrationStatus = function() {
            migrationManager.status = {
                inProgress: false,
                completed: false,
                error: null,
                migratedRegions: 0,
                totalRegions: 0,
                details: []
            };
            
            document.getElementById('migrationResult').innerHTML = '';
            document.getElementById('migrationDetails').style.display = 'none';
            document.getElementById('migrationProgress').style.display = 'none';
            
            document.getElementById('emergencyResults').innerHTML = `
                <div class="status info">
                    â„¹ï¸ è¿ç§»çŠ¶æ€å·²é‡ç½®
                </div>
            `;
        };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkMigrationStatus();
        };
    </script>
</body>
</html>
